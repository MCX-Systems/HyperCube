/*!
 * smoothState.js is jQuery plugin that progressively enhances
 * page loads to behave more like a single-page application.
 *
 * @author  Miguel Ángel Pérez   reachme@miguel-perez.com
 * @see     http://smoothstate.com
 *
 */
(function(a){if(typeof module==="object"&&typeof module.exports==="object"){a(require("jquery"),window,document)}else{a(jQuery,window,document)}}(function(f,h,j,c){if(!h.history.pushState){f.fn.smoothState=function(){return this};f.fn.smoothState.options={};return}if(f.fn.smoothState){return}var e=f("html, body"),i=h.console,d={debug:false,anchors:"a",hrefRegex:"",forms:"form",allowFormCaching:false,repeatDelay:500,blacklist:".no-smoothState",prefetch:false,prefetchOn:"mouseover touchstart",prefetchBlacklist:".no-prefetch",locationHeader:"X-SmoothState-Location",cacheLength:0,loadingClass:"is-loading",scroll:true,alterRequest:function(l){return l},alterChangeState:function(m,n,l){return m},onBefore:function(l,m){},onStart:{duration:0,render:function(l){}},onProgress:{duration:0,render:function(l){}},onReady:{duration:0,render:function(m,l){m.html(l)}},onAfter:function(m,l){}},k={isExternal:function(m){var l=m.match(/^([^:\/?#]+:)?(?:\/\/([^\/?#]*))?([^?#]+)?(\?[^#]*)?(#.*)?/);if(typeof l[1]==="string"&&l[1].length>0&&l[1].toLowerCase()!==h.location.protocol){return true}if(typeof l[2]==="string"&&l[2].length>0&&l[2].replace(new RegExp(":("+{"http:":80,"https:":443}[h.location.protocol]+")?$"),"")!==h.location.host){return true}return false},stripHash:function(l){return l.replace(/#.*/,"")},isHash:function(l,n){n=n||h.location.href;var m=(l.indexOf("#")>-1)?true:false,o=(k.stripHash(l)===k.stripHash(n))?true:false;return(m&&o)},translate:function(l){var m={dataType:"html",type:"GET"};if(typeof l==="string"){l=f.extend({},m,{url:l})}else{l=f.extend({},m,l)}return l},shouldLoadAnchor:function(n,m,o){var l=n.prop("href");return(!k.isExternal(l)&&!k.isHash(l)&&!n.is(m)&&!n.prop("target"))&&(typeof o===c||o===""||n.prop("href").search(o)!==-1)},clearIfOverCapacity:function(l,m){if(!Object.keys){Object.keys=function(p){var o=[],n;for(n in p){if(Object.prototype.hasOwnProperty.call(p,n)){o.push(n)}}return o}}if(Object.keys(l).length>m){l={}}return l},storePageIn:function(n,m,q,r,p,o){var l=f("<html></html>").append(f(q));if(typeof p==="undefined"){p={}}if(typeof o==="undefined"){o=m}n[m]={status:"loaded",title:l.find("title").first().text(),html:l.find("#"+r),doc:q,state:p,destUrl:o};return n},triggerAllAnimationEndEvent:function(l,r){r=" "+r||"";var s=0,p="animationstart webkitAnimationStart oanimationstart MSAnimationStart",m="animationend webkitAnimationEnd oanimationend MSAnimationEnd",o="allanimationend",n=function(t){if(f(t.delegateTarget).is(l)){t.stopPropagation();s++}},q=function(t){if(f(t.delegateTarget).is(l)){t.stopPropagation();s--;if(s===0){l.trigger(o)}}};l.on(p,n);l.on(m,q);l.on("allanimationend"+r,function(){s=0;k.redraw(l)})},redraw:function(l){l.height()}},b=function(q){if(q.state!==null){var n=h.location.href,m=f("#"+q.state.id),p=m.data("smoothState"),l=(p.href!==n&&!k.isHash(n,p.href)),o=(q.state!==p.cache[p.href].state);if(l||o){if(o){p.clear(p.href)}p.load(n,false)}}},a=function(m,n){var G=f(m),w=G.prop("id"),C=null,r=false,z={},p={},q=h.location.href,D=function(I){I=I||false;if(I&&z.hasOwnProperty(I)){delete z[I]}else{z={}}G.data("smoothState").cache=z},E=function(K,L){L=L||f.noop;var J=k.translate(K);z=k.clearIfOverCapacity(z,n.cacheLength);if(z.hasOwnProperty(J.url)&&typeof J.data==="undefined"){return}z[J.url]={status:"fetching"};var I=f.ajax(J);I.done(function(M){k.storePageIn(z,J.url,M,w);G.data("smoothState").cache=z});I.fail(function(){z[J.url].status="error"});if(n.locationHeader){I.always(function(P,N,O){var Q=(P.statusCode?P:O),M=Q.getResponseHeader(n.locationHeader);if(M){z[J.url].destUrl=M}})}if(L){I.always(L)}},o=function(){if(C){var I=f(C,G);if(I.length){var J=I.offset().top;e.scrollTop(J)}C=null}},v=function(K){var J="#"+w,I=z[K]?f(z[K].html.html()):null;if(I.length){j.title=z[K].title;G.data("smoothState").href=K;if(n.loadingClass){e.removeClass(n.loadingClass)}n.onReady.render(G,I);G.one("ss.onReadyEnd",function(){r=false;n.onAfter(G,I);if(n.scroll){o()}A(G)});h.setTimeout(function(){G.trigger("ss.onReadyEnd")},n.onReady.duration)}else{if(!I&&n.debug&&i){i.warn("No element with an id of "+J+" in response from "+K+" in "+z)}else{h.location=K}}},s=function(M,I,L){var K=k.translate(M);if(typeof I==="undefined"){I=true}if(typeof L==="undefined"){L=true}var O=false,J=false,N={loaded:function(){var P=O?"ss.onProgressEnd":"ss.onStartEnd";if(!J||!O){G.one(P,function(){v(K.url);if(!L){D(K.url)}})}else{if(J){v(K.url)}}if(I){var Q=z[K.url].destUrl;p=n.alterChangeState({id:w},z[K.url].title,Q);z[K.url].state=p;h.history.pushState(p,z[K.url].title,Q)}if(J&&!L){D(K.url)}},fetching:function(){if(!O){O=true;G.one("ss.onStartEnd",function(){if(n.loadingClass){e.addClass(n.loadingClass)}n.onProgress.render(G);h.setTimeout(function(){G.trigger("ss.onProgressEnd");J=true},n.onProgress.duration)})}h.setTimeout(function(){if(z.hasOwnProperty(K.url)){N[z[K.url].status]()}},10)},error:function(){if(n.debug&&i){i.log("There was an error loading: "+K.url)}else{h.location=K.url}}};if(!z.hasOwnProperty(K.url)){E(K)}n.onStart.render(G);h.setTimeout(function(){if(n.scroll){e.scrollTop(0)}G.trigger("ss.onStartEnd")},n.onStart.duration);N[z[K.url].status]()},l=function(K){var J,I=f(K.currentTarget);if(k.shouldLoadAnchor(I,n.blacklist,n.hrefRegex)&&!r){K.stopPropagation();J=k.translate(I.prop("href"));J=n.alterRequest(J);E(J)}},B=function(K){var J=f(K.currentTarget);if(!K.metaKey&&!K.ctrlKey&&k.shouldLoadAnchor(J,n.blacklist,n.hrefRegex)){K.stopPropagation();K.preventDefault();if(!H()){t();var I=k.translate(J.prop("href"));r=true;C=J.prop("hash");I=n.alterRequest(I);n.onBefore(J,G);s(I)}}},u=function(K){var I=f(K.currentTarget);if(!I.is(n.blacklist)){K.preventDefault();K.stopPropagation();if(!H()){t();var J={url:I.prop("action"),data:I.serialize(),type:I.prop("method")};r=true;J=n.alterRequest(J);if(J.type.toLowerCase()==="get"){J.url=J.url+"?"+J.data}n.onBefore(I,G);s(J,c,n.allowFormCaching)}}},x=0,H=function(){var I=(n.repeatDelay===null);var J=(parseInt(Date.now())>x);return !(I||J)},t=function(){x=parseInt(Date.now())+parseInt(n.repeatDelay)},A=function(I){if(n.anchors&&n.prefetch){I.find(n.anchors).not(n.prefetchBlacklist).on(n.prefetchOn,null,l)}},y=function(I){if(n.anchors){I.on("click",n.anchors,B);A(I)}if(n.forms){I.on("submit",n.forms,u)}},F=function(){var I=G.prop("class");G.removeClass(I);k.redraw(G);G.addClass(I)};n=f.extend({},f.fn.smoothState.options,n);if(h.history.state===null){p=n.alterChangeState({id:w},j.title,q);h.history.replaceState(p,j.title,q)}else{p={}}k.storePageIn(z,q,j.documentElement.outerHTML,w,p);k.triggerAllAnimationEndEvent(G,"ss.onStartEnd ss.onProgressEnd ss.onEndEnd");y(G);return{href:q,cache:z,clear:D,load:s,fetch:E,restartCSSAnimations:F}},g=function(l){return this.each(function(){var m=this.tagName.toLowerCase();if(this.id&&m!=="body"&&m!=="html"&&!f.data(this,"smoothState")){f.data(this,"smoothState",new a(this,l))}else{if(!this.id&&i){i.warn("Every smoothState container needs an id but the following one does not have one:",this)}else{if((m==="body"||m==="html")&&i){i.warn("The smoothstate container cannot be the "+this.tagName+" tag")}}}})};h.onpopstate=b;f.smoothStateUtility=k;f.fn.smoothState=g;f.fn.smoothState.options=d}));