(function(a){if(typeof module==="object"&&typeof module.exports==="object"){module.exports=a(jQuery)}else{a(jQuery)}}(function(b){var a=function(d){this._opt=null;if(this._isNotEmpty(d,"url")){this._opt=d}else{throw new Error("Missing argument, example usage: $.simpleWebSocket({ url: 'ws://127.0.0.1:3000' }); ")}this._ws=null;this._reConnectTries=60;this._reConnectDeferred=null;this._dataType=this._prop(this._opt,"dataType","json");this._listeners=[];var c=this;this._api=(function(){return{connect:function(){return b.extend(c._api,c._reConnect.apply(c,[]))},isConnected:function(e){if(e){e.apply(this,[c._isConnected.apply(c,[])]);return c._api}else{return c._isConnected.apply(c,[])}},send:function(e){return b.extend(c._api,c._send.apply(c,[e]))},listen:function(e){return b.extend(c._api,c._listenReconnect.apply(c,[e]))},remove:function(e){c._remove.apply(c,[e]);return c._api},removeAll:function(){c._removeAll.apply(c,[]);return c._api},close:function(){c._close.apply(c,[]);c._reset.apply(c,[]);return c._api}}})();return this._api};a.prototype={_createWebSocket:function(d){var c;if(d.protocols){c=(typeof window.MozWebSocket!=="undefined")?new MozWebSocket(d.url,d.protocols):window.WebSocket?new WebSocket(d.url,d.protocols):null}else{c=(typeof window.MozWebSocket!=="undefined")?new MozWebSocket(d.url):window.WebSocket?new WebSocket(d.url):null}if(!c){throw new Error("Error, websocket could not be initialized.")}return c},_bindSocketEvents:function(c,e){var d=this;b(c).bind("open",e.open).bind("close",e.close).bind("message",function(h){try{if(typeof e.message==="function"){if(d._dataType&&d._dataType.toLowerCase()==="json"){var g=JSON.parse(h.originalEvent.data);e.message.call(this,g)}else{if(d._dataType&&d._dataType.toLowerCase()==="xml"){var j=new DOMParser();var i=j.parseFromString(h.originalEvent.data,"text/xml");e.message.call(this,i)}else{e.message.call(this,h.originalEvent.data)}}}}catch(f){if(typeof e.error==="function"){e.error.call(this,f)}}}).bind("error",function(f){if(typeof e.error==="function"){e.error.call(this,f)}})},_webSocket:function(d){var c=this._createWebSocket(d);this._bindSocketEvents(c,d);return c},_getSocketEventHandler:function(d){var c=this;return{open:function(g){var f=this;if(d){d.resolve(f)}},close:function(f){if(d){d.rejectWith(f)}},message:function(h){for(var g=0,e=c._listeners.length;g<e;g++){try{c._listeners[g].deferred.notify.apply(c,[h])}catch(f){}}},error:function(h){c._ws=null;for(var g=0,f=c._listeners.length;g<f;g++){c._listeners[g].deferred.reject.apply(c,[h])}if(d){d.rejectWith.apply(c,[h])}}}},_connect:function(){var c=b.Deferred();if(this._ws){if(this._ws.readyState===2||this._ws.readyState===3){this._ws.close()}else{if(this._ws.readyState===0){return c.promise()}else{if(this._ws.readyState===1){c.resolve(this._ws);return c.promise()}}}}this._ws=this._webSocket(b.extend(this._opt,this._getSocketEventHandler(c)));return c.promise()},_reset:function(){this._reConnectTries=this._prop(this._opt,"attempts",60);this._reConnectDeferred=b.Deferred()},_close:function(){if(this._ws){this._ws.close();this._ws=null}},_isConnected:function(){return this._ws!==null&&this._ws.readyState===1},_reConnectTry:function(){var c=this;this._connect().done(function(){c._reConnectDeferred.resolve.apply(c,[c._ws])}).fail(function(d){c._reConnectTries--;if(c._reConnectTries>0){window.setTimeout(function(){c._reConnect.apply(c,[])},c._prop.apply(c,[c._opt,"timeout",10000]))}else{c._reConnectDeferred.rejectWith.apply(c,[d])}})},_reConnect:function(){var c=this;if(!this._reConnectDeferred||this._reConnectDeferred.state()!=="pending"){this._reset()}if(this._ws&&this._ws.readyState===1){this._reConnectDeferred.resolve(this._ws)}else{this._reConnectTry()}return c._reConnectDeferred.promise.apply(c,[])},_preparePayload:function(c){var d;if(this._opt.dataType&&this._opt.dataType.toLowerCase()==="text"){d=c}else{if(this._opt.dataType&&this._opt.dataType.toLowerCase()==="xml"){d=c}else{if(this._opt.dataType&&this._opt.dataType.toLowerCase()==="json"){d=JSON.stringify(c)}else{d=JSON.stringify(c)}}}return d},_send:function(e){var c=this;var d=b.Deferred();(function(f){c._reConnect.apply(c,[]).done(function(g){g.send(f);d.resolve.apply(c,[c._api])}).fail(function(g){d.rejectWith.apply(c,[g])})})(this._preparePayload(e));return d.promise()},_indexOfListener:function(e){for(var d=0,c=this._listeners.length;d<c;d++){if(this._listeners[d].listener===e){return d}}return -1},_isNotEmpty:function(d,c){return typeof d!=="undefined"&&d!==null&&typeof c!=="undefined"&&c!==null&&c!==""&&typeof d[c]!=="undefined"&&d[c]!==null&&d[c]!==""},_prop:function(e,d,c){if(this._isNotEmpty(e,d)){return e[d]}return c},_listen:function(e){var d=this;var c=b.Deferred();d._reConnect.apply(d,[]).done(function(){c.progress(function(){e.apply(this,arguments)});d._remove.apply(d,[e]);d._listeners.push({deferred:c,listener:e})}).fail(function(f){c.reject(f)});return c.promise()},_listenReconnect:function(d){var e=b.Deferred();var c=this;this._listen(d).fail(function(){e.notify(arguments);c._listenReconnect.apply(c,[d])}).done(function(){e.resolve()});return e.promise()},_remove:function(d){var c=this._indexOfListener(d);if(c!==-1){this._listeners[c].deferred.resolve();this._listeners.splice(c,1)}},_removeAll:function(){for(var d=0,c=this._listeners.length;d<c;d++){this._listeners[d].deferred.resolve()}this._listeners=[]}};b.extend({simpleWebSocket:function(c){return new a(c)}});return b.simpleWebSocket}));